<?xml version="1.0" encoding="UTF-8"?>
<project name="xlite" default="build" basedir=".">

	<taskdef name="jmeter" classname="org.programmerplanet.ant.taskdefs.jmeter.JMeterTask" />

	<target name="build" depends="set-properties,clean,update,prepare,php-documentor,tests,analysis,create-build" />

	<target name="cc" depends="set-properties-cc,clean,update,prepare,php-documentor,tests-cc,analysis,create-build" />

	<target name="pure-build" depends="set-properties,clean,update,prepare,php-documentor,create-build" />

	<target name="set-properties" depends="set-properties-common">
		<property name="mode" value="manual" />
		<property name="root" location="${basedir}/../.." />
		<property name="buildDir" location="${root}/build" />
		<property name="sourceDir" location="${root}" />
		<property name="jmeterDir" location="${sourceDir}/.dev/lib/jmeter" />
		<property name="srcDir" location="${sourceDir}/test" />
	</target>

    <target name="set-properties-cc" depends="set-properties-common">
		<property name="mode" value="cc" />
		<property name="root" location="${basedir}" />
        <property name="buildDir" location="${root}/build" />
        <property name="sourceDir" location="${root}/source" />
		<property name="jmeterDir" location="/u/xcart/jakarta-jmeter-2.3.4" />
        <property name="srcDir" location="${sourceDir}/test" />
    </target>

    <target name="set-properties-common">
        <property name="version" value="3.0-ee" />
		<property name="apiUrl" value="http://xcart2-530.crtdev.local/~max/xlite/build/api" />
    </target>

    <target name="clean">
        <delete dir="${buildDir}" />
        <mkdir dir="${buildDir}" />
        <mkdir dir="${buildDir}/logs" />
		<mkdir dir="${buildDir}/api" />
		<mkdir dir="${buildDir}/reports" />
    </target>

	<target name="update">
		<exec executable="svn" dir="${sourceDir}">
			<arg line="up" />
		</exec>
	</target>

    <target name="prepare">
        <exec executable="${sourceDir}/.dev/build/release/release.sh" dir="${buildDir}">
            <arg line="-c" />
        </exec>
		<exec executable="/usr/bin/tar" dir="${buildDir}">
			<arg line="-xzf ${buildDir}/output/litecommerce-3.0.tgz" />
		</exec>
		<move file="${buildDir}/litecommerce" tofile="${buildDir}/src" />
        <exec executable="/usr/local/php-530/bin/php" dir="${buildDir}/src">
            <arg line="${sourceDir}/.dev/build/devcode_postprocess.php" />
        </exec>
	</target>

	<target name="php-documentor">
		<!-- PHP Documentor temporary disabled as documentation in PHP files is corrupted
        <exec executable="/usr/local/php-530/bin/php" dir="${buildDir}/src">
            <arg line="${sourceDir}/.dev/build/phpdoc_postprocess.php ${apiUrl}" />
		</exec>
		<exec executable="/u/xcart/phpdoc" dir="${buildDir}">
			<arg line="-ct type -ue on -t ${buildDir}/api -d ${srcDir}/classes/XLite -it @see -dn LiteCommerce -dc LiteCommerce" />
			<redirector outputproperty="${buildDir}/logs/phpdoc.log">
				<outputmapper type="merge" to="${buildDir}/logs/phpdoc.log"/>
			</redirector>
		</exec>
		-->
	</target>

	<target name="tests" depends="plint,php-codesniffer,phpunit,jmeter,pdepend" />

	<target name="tests-cc" depends="prepare-db,plint,php-codesniffer-cc,phpunit-cc,jmeter,pdepend" />

	<target name="prepare-db">
        <copy todir="${buildDir}/src/etc">
            <fileset file="${sourceDir}/.dev/build/config.local.php" />
        </copy>
        <copy todir="${buildDir}/src">
            <fileset file="${srcDir}/restoredb" />
        </copy>
		<exec executable="/usr/local/php-530/bin/php" dir="${buildDir}/src" failonerror="on">
			<arg line="${buildDir}/src/restoredb demo" />
		</exec>
        <exec executable="/usr/local/php-530/bin/php" dir="${buildDir}/src">
            <arg line="${sourceDir}/.dev/build/build-classes.php" />
        </exec>
	</target>

	<target name="php-codesniffer">
		<exec executable="${sourceDir}/.dev/phpcs" dir="${buildDir}/src" output="${buildDir}/reports/checkstyle.txt">
			<arg line="--report=full --standard=${sourceDir}/.dev/code-sniffs/XLite --ignore=.dev,src/etc,src/var ${buildDir}/src/classes" />
		</exec>
	</target>

    <target name="php-codesniffer-cc">
        <exec executable="${sourceDir}/.dev/phpcs" dir="${buildDir}/src" output="${buildDir}/logs/checkstyle.xml">
            <arg line="--report=checkstyle --standard=${sourceDir}/.dev/code-sniffs/XLite --ignore=.dev,src/etc,src/var ${buildDir}/src/classes" />
        </exec>
    </target>

	<target name="phpunit">
        <copy todir="${buildDir}">
            <fileset file="${sourceDir}/.dev/tests/PHPUnit/phpunit_coverage.php" />
        </copy>
		<exec executable="phpunit" dir="${buildDir}" failonerror="on" output="${buildDir}/reports/phpunit.txt">
			<arg line="--log-xml ${buildDir}/logs/phpunit.xml --coverage-html ${buildDir}/logs/coverage xliteAllTests ${buildDir}/.dev/tests/AllTests.php" />
		</exec>
        <exec executable="/usr/local/php-530/bin/php" dir="${sourceDir}">
            <arg line=".dev/tests/graph.php ${buildDir}/logs/phpunit.xml.speed ${buildDir}/reports ../../../artifacts/xlite" />
        </exec>
	</target>

    <target name="phpunit-cc">
        <copy todir="${buildDir}">
            <fileset file="${sourceDir}/.dev/tests/PHPUnit/phpunit_coverage.php" />
        </copy>
        <exec executable="/u/xcart/bin/phpunit" dir="${buildDir}" failonerror="on">
            <arg line="--log-xml ${buildDir}/logs/phpunit.xml --log-pmd ${buildDir}/logs/phpunit.pmd.xml --log-metrics ${buildDir}/logs/phpunit.metrics.xml --coverage-xml ${buildDir}/logs/phpunit.coverage.xml --coverage-html ${buildDir}/coverage xliteAllTests ${buildDir}/.dev/tests/AllTests.php" />
        </exec>
		<exec executable="/usr/local/php-530/bin/php" dir="${sourceDir}">
			<arg line=".dev/tests/graph.php ${buildDir}/logs/phpunit.xml.speed ${buildDir}/reports ../../../artifacts/xlite" />
		</exec>
    </target>

	<target name="jmeter">
		<jmeter jmeterhome="${jmeterDir}" testplan="${sourceDir}/.dev/loadtests/JMeterLoadTest.jmx" resultlog="${buildDir}/logs/JMeterResults.jtl">
		</jmeter>
		<xslt in="${buildDir}/logs/JMeterResults.jtl" out="${buildDir}/reports/jmeter.html" style="${sourceDir}/.dev/loadtests/jmeter-results-report.xsl" />
		<exec executable="/usr/local/php-530/bin/php" dir="${sourceDir}">
			<arg line=".dev/loadtests/graph.php ${buildDir}/logs/JMeterResults.jtl ${buildDir}/reports ../../../artifacts/xlite" />
		</exec>
	</target>

	<target name="plint">
		<exec executable="${sourceDir}/.dev/phpl.sh" dir="${buildDir}/src" failonerror="true" output="${buildDir}/reports/plint.html" />
	</target>

	<target name="pdepend">
		<exec executable="/usr/local/php-530/bin/php" dir="${buildDir}">
			<arg line="${sourceDir}/.dev/pdepend.php --jdepend-chart=${buildDir}/reports/pdepend.svg --overview-pyramid=${buildDir}/reports/pyramid.svg --optimization=best ${buildDir}/src/var/run/classes" />
		</exec>
	</target>

	<target name="analysis">
		<exec executable="svn" dir="${sourceDir}" output="${buildDir}/reports/xlite-svn.log">
			<arg line="log --verbose --xml" />
		</exec>
		<exec executable="python" dir="${sourceDir}" output="${buildDir}/reports/xlite.gource">
			<arg line="${sourceDir}/.dev/build/svn-gource.py --filter-dirs ${buildDir}/reports/xlite-svn.log" />
		</exec>
		<mkdir dir="${buildDir}/reports/statsvn" />
        <exec executable="java" dir="${sourceDir}" output="/dev/null">
            <arg line="-jar ${sourceDir}/.dev/build/statsvn/statsvn.jar -title LiteCommerce -output-dir ${buildDir}/reports/statsvn ${buildDir}/reports/xlite-svn.log ${sourceDir}" />
        </exec>
        <delete>
            <fileset file="${buildDir}/reports/xlite-svn.log" />
        </delete>
	</target>

	<target name="create-build">
		<delete>
			<fileset dir="${buildDir}/.dev" />
		</delete>
		<!--tar destfile="${buildDir}/xlite-${version}.tgz" basedir="${buildDir}/src" compression="gzip" /-->
		<tar destfile="${buildDir}/xlite-${version}-api.tgz" basedir="${buildDir}/api" compression="gzip" />
    </target>
</project>
